<div class="content-section content-section--vm-testimonials vm-testimonials js-vm-testimonials">
  <div class="container">
    <div class="row">
      <!-- <div class="six columns medium-down--sixteen">
        <div class="vm-testimonials__slide-title-links">
          {% for block in section.blocks %}
            <h3 class="vm-testimonials__slide-title-link js-testimonial-slide-title-link {% if forloop.first %}is-active{% endif %}" data-slide-index="{{ forloop.index }}">
              &ldquo;{{ block.settings.title }}&rdquo;
            </h3>
          {% endfor %}
        </div>
      </div> -->

      <div class="twelve columns offset-by-two medium-down--sixteen">
        {% for block in section.blocks %}
          <div class="vm-testimonial-slide vm-testimonial-slide--index-{{ index }} js-testimonial-slide {% if forloop.first %}is-active{% endif %}" data-slide-index="{{ forloop.index }}">
            <div class="vm-testimonial-slide__content">
              <h2 class="vm-testimonial-slide__title heading-1">
                &ldquo;{{ block.settings.title }}&rdquo;
              </h2>
              
              <p class="vm-testimonial-slide__testimonial paragraph--block-text">
                &ldquo;{{ block.settings.testimonial | strip_html }}&rdquo;
              </p>
              
              {% if block.settings.name != blank %}
                <h4 class="vm-testimonial-slide__name subheading-2">
                  - {{ block.settings.name }}
                </h4>
              {% endif %}
            </div>
          </div>
        {% endfor %}

        <div class="vm-testimonial__buttons-wrapper">
          <button class="vm-testimonial__slide-button vm-testimonial__slide-button--prev js-testimonials-prev-button">
            <svg id="RightArrow" data-name="RightArrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 35.26 8.52"><polygon points="35.26 4.26 29.7 0 29.7 3.26 0 3.26 0 5.26 29.7 5.26 29.7 8.52 35.26 4.26"/></svg>
          </button>

          <h6 class="vm-testimonial__slide-index-indicator">
            <span class="js-testimonials-slide-index">1</span>
            <span class="divider">/</span>
            <span>{{ section.blocks.size }}</span>
          </h6>
          
          <button class="vm-testimonial__slide-button vm-testimonial__slide-button--next js-testimonials-next-button">
            <svg id="RightArrow" data-name="RightArrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 35.26 8.52"><polygon points="35.26 4.26 29.7 0 29.7 3.26 0 3.26 0 5.26 29.7 5.26 29.7 8.52 35.26 4.26"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Constants
  const SLIDE_INDEX_ATTR = "data-slide-index";
  const IS_ACTIVE_CLASS = "is-active";
  const IS_HIDDEN_CLASS = "is-hidden";
  const NO_TRANSITION_CLASS = "no-transition";
  const HIDE_TRANSITION_TIME = 500;
  
  // State
  let currentActiveSlideIndex = 1;
  let fadeOutTimeout = null;
  let fadeInTimeout = null;
  let isAnimating = false;
  
  // DOM Elements
  const testimonialsRoot = document.querySelector('.js-vm-testimonials');
  const slideElements = testimonialsRoot.querySelectorAll('.js-testimonial-slide');
  const prevButton = testimonialsRoot.querySelector('.js-testimonials-prev-button');
  const nextButton = testimonialsRoot.querySelector('.js-testimonials-next-button');
  const slideIndicator = testimonialsRoot.querySelector('.js-testimonials-slide-index');

  function getElementSlideIndex(element) {
    const indexAsString = element.getAttribute(SLIDE_INDEX_ATTR);
    
    if (!indexAsString) {
      return -1;
    }

    const index = parseInt(indexAsString, 10);
    return index;
  }

  function getElementBySlideIndex(elements, targetSlideIndex) {
    for (let i = 0; i < elements.length; i++) {
      const currentElement = elements[i];
      const slideIndex = getElementSlideIndex(currentElement);
      
      if (slideIndex === targetSlideIndex) {
        return currentElement;
      }
    }
  }
  
  function getCurrentActiveSlide() {
    return getElementBySlideIndex(slideElements, currentActiveSlideIndex);
  }

  function getPreviousSlideIndex() {
    let prevSlideIndex = currentActiveSlideIndex - 1;

    // Wrap around to the end
    if (prevSlideIndex < 1) {
      prevSlideIndex = slideElements.length;
    }

    return prevSlideIndex;
  }
  
  function getNextSlideIndex() {
    let nextSlideIndex = currentActiveSlideIndex + 1;

    // Wrap around to the beginning
    if (nextSlideIndex > slideElements.length) {
      nextSlideIndex = 1;
    }

    return nextSlideIndex;
  }

  function transitionToSlideIndex(newSlideIndex) {
    if (newSlideIndex === currentActiveSlideIndex) {
      return;
    }

    isAnimating = true;

    const currentActiveSlide = getCurrentActiveSlide();
    const targetSlide = getElementBySlideIndex(slideElements, newSlideIndex);
    
    currentActiveSlide.classList.add(IS_HIDDEN_CLASS);
    
    currentActiveSlideIndex = newSlideIndex;

    slideIndicator.innerHTML = currentActiveSlideIndex;
    
    fadeOutTimeout = setTimeout(function() {
      currentActiveSlide.classList.remove(IS_ACTIVE_CLASS);

      targetSlide.classList.add(NO_TRANSITION_CLASS);
      targetSlide.classList.add(IS_HIDDEN_CLASS);
      targetSlide.classList.remove(NO_TRANSITION_CLASS);

      targetSlide.classList.add(IS_ACTIVE_CLASS);

      fadeInTimeout = setTimeout(function() {
        targetSlide.classList.remove(IS_HIDDEN_CLASS);
        isAnimating = false;
      }, 100)
    }, HIDE_TRANSITION_TIME);
  }

  // Event handlers
  prevButton.addEventListener('click', function onPrevButtonClicked() {
    if (isAnimating) {
      return;
    }
    
    const slideIndex = getPreviousSlideIndex();
    transitionToSlideIndex(slideIndex);
  });
  
  nextButton.addEventListener('click', function onNextButtonClicked() {
    if (isAnimating) {
      return;
    }

    const slideIndex = getNextSlideIndex();
    transitionToSlideIndex(slideIndex);
  });
})();
</script>

{% schema %}

{
  "name": "Testimonials",
  "class": "testimonial-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "wide_display",
      "label": "Wide display",
      "default": true
    },
    {
      "type": "select",
      "id": "testimonial_text_animation",
      "label": "Text animation",
      "options": [
        {
          "value": "",
          "label": "None"
        },
        {
          "value": "fadeIn",
          "label": "Fade In"
        },
        {
          "value": "fadeInUp",
          "label": "Fade Up"
        },
        {
          "value": "fadeInDown",
          "label": "Fade Down"
        }
      ],
      "default": "fadeInDown"
    },
    {
      "type": "range",
      "id": "testimonial_speed",
      "label": "Change testimonials every",
      "min": 0,
      "max": 12,
      "step": 1,
      "default": 6,
      "unit": "sec"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Customer Testimonial"
        },
        {
          "type": "richtext",
          "id": "testimonial",
          "label": "Testimonial",
          "default": "<p>Include some of your favorite customer quotes and feedback here as social proof, to build credibility and trust for your services and products.</p>"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Customer name"
        },
        {
          "type": "text",
          "id": "store_name",
          "label": "Store name"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Store link"
        },
        {
          "type": "select",
          "id": "text_position",
          "label": "Text position",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "center"
        },
        {
          "type": "select",
          "id": "text_align",
          "label": "Text alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "center"
        },
        {
          "type": "header",
          "content": "Background image"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "1600 x 1000px recommended"
        },
        {
          "type": "checkbox",
          "id": "darken_bg",
          "label": "Darken background image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "category": "Text",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}

{% endschema %}
